#!/usr/bin/ruby

require 'json'

$stdout.sync = false

def egress_ip
  %x(dig +short myip.opendns.com @resolver1.opendns.com).chomp.tap do |egress|
    return "n/a" unless $?.success?
  end
end

puts STDIN.readline
puts STDIN.readline

STDIN.each_line do |line|
  line = line.match(/^,?(.*)/)[1]
  blocks = JSON.parse(line)
  blocks.unshift({
    name: "egress",
    full_text: "E: #{egress_ip}",
    color: "#FFFF00"
  })
  puts "#{JSON.dump(blocks)},"
end
